/*! tommyProject 2013-04-24 */
function createPolygon(e,o,t,a){var n=new b2PolygonDef;a&&a.flipper===!0&&(n.density=5),n.vertexCount=t.length,n.userData=a,n.restitution=.5,void 0!=a.isSensor&&(n.isSensor=!0),void 0!=a&&void 0!=a.restitution&&(n.restitution=a.restitution);for(var r=0;t.length>r;r++){var s=pixelToB2dCoords(t[r][0],t[r][1]);n.vertices[r].Set(s.x,s.y)}var i=new b2BodyDef,l=pixelToB2dCoords(e,o);i.position.Set(l.x,l.y),null!=a&&0==a.allowSleep&&(i.allowSleep=!1);var _=box2Ob.world.CreateBody(i);return _.CreateShape(n),_}function CreateRect(e,o,t){return createPolygon(e[0],e[1],[[0,0],[o[0],0],[o[0],o[1]],[0,o[1]]],t)}function CreateCircle(e,o,t){var a=new b2CircleDef;a.radius=(o||BALL_RADIUS)/COORDINATE_SCALE_FACTOR,a.restitution=.5,void 0!=t.isSensor&&(a.isSensor=!0),void 0!=t.restitution&&(a.restitution=t.restitution),a.friction=.01,a.userData=t;var n=new b2BodyDef;n.position.Set(e[0]/COORDINATE_SCALE_FACTOR,e[1]/COORDINATE_SCALE_FACTOR);var r=box2Ob.world.CreateBody(n);return r.CreateShape(a),r.SetMassFromShapes(),r}function createRampBlocker(){var e=LAUNCHER_WIDTH+2*BORDER_WIDTH+30*TABLE_SIZE_SCALE;rampBlocker=createPolygon(INNER_WIDTH-(e-LAUNCHER_WIDTH+17*TABLE_SIZE_SCALE),CEILING_HEIGHT+LAUNCHER_DROPOFF,[[e,0],[0,-CEILING_HEIGHT],[e,-CEILING_HEIGHT]],{restitution:0,force:20,shapeName:"Ceiling",sound:WOOD_SOUND})}function setupBoard(){CreateRect([TABLE_LEFT,ACTUAL_TABLE_HEIGHT+TABLE_TOP+4*BALL_RADIUS],[ACTUAL_TABLE_WIDTH,BORDER_WIDTH],{drawShape:!1,shapeName:"TheGround",collidesWithBall:!0,force:10*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE}),launcher=CreateRect([TABLE_LEFT+ACTUAL_TABLE_WIDTH-2*BALL_RADIUS-BORDER_WIDTH+1.5*TABLE_SIZE_SCALE,ACTUAL_TABLE_HEIGHT+TABLE_TOP-57*TABLE_SIZE_SCALE],[2*BALL_RADIUS-7*TABLE_SIZE_SCALE,20],{drawShape:!1,shapeName:"Launcher",collidesWithBall:!0,force:0,restitution:0}),CreateRect([ACTUAL_TABLE_WIDTH+TABLE_LEFT-BORDER_WIDTH,TABLE_TOP],[BORDER_WIDTH,ACTUAL_TABLE_HEIGHT],{drawShape:!1,shapeName:"BoundingBox",sound:WOOD_SOUND}),CreateRect([ACTUAL_TABLE_WIDTH+TABLE_LEFT-2*BORDER_WIDTH-LAUNCHER_WIDTH,TABLE_TOP+CEILING_HEIGHT+LAUNCHER_DROPOFF],[BORDER_WIDTH,ACTUAL_TABLE_HEIGHT-CEILING_HEIGHT-LAUNCHER_DROPOFF],{drawShape:!1,shapeName:"BoundingBox",sound:WOOD_SOUND}),CreateRect([TABLE_LEFT,TABLE_TOP],[BORDER_WIDTH,ACTUAL_TABLE_HEIGHT],{drawShape:!1,shapeName:"BoundingBox",sound:WOOD_SOUND});for(var e=[0,5,10,20,40,100],o=0;e.length-1>o;o++){var t=(ACTUAL_TABLE_WIDTH/2+(ACTUAL_TABLE_WIDTH-INNER_WIDTH)/2-2*BORDER_WIDTH)/(e.length-1),a=[[0,0],[t,0],[t,e[o+1]*TABLE_SIZE_SCALE],[0,e[o]*TABLE_SIZE_SCALE]],n=ACTUAL_TABLE_WIDTH/2+t*o+BORDER_WIDTH+TABLE_LEFT-(ACTUAL_TABLE_WIDTH-INNER_WIDTH)/2;createPolygon(n,BORDER_WIDTH+TABLE_TOP,a,{shapeName:"Ceiling",sound:WOOD_SOUND}),t=(INNER_WIDTH/2-2*BORDER_WIDTH)/(e.length-1);var a=[[0,0],[t,0],[t,e[e.length-o-2]*TABLE_SIZE_SCALE],[0,e[e.length-o-1]*TABLE_SIZE_SCALE]];createPolygon(t*o+BORDER_WIDTH+TABLE_LEFT,BORDER_WIDTH+TABLE_TOP,a,{shapeName:"Ceiling",sound:WOOD_SOUND})}var r=1.5*BALL_RADIUS,s=CEILING_HEIGHT-30,i=INNER_WIDTH/2-80;CreateCircle([TABLE_CENTER-i,s],r,{isSensor:!0,shapeName:"TopLeftSensor",points:TOP_LEFT_SENSOR_POINTS});for(var l=[[DIAMOND_WIDTH/2,0],[DIAMOND_WIDTH,DIAMOND_TIP_HEIGHT],[DIAMOND_WIDTH,DIAMOND_HEIGHT-DIAMOND_TIP_HEIGHT],[DIAMOND_WIDTH/2,DIAMOND_HEIGHT],[0,DIAMOND_HEIGHT-DIAMOND_TIP_HEIGHT],[0,DIAMOND_TIP_HEIGHT]],o=-2;2>=o;o++)createPolygon(INNER_WIDTH/2+(DIAMOND_GAP+DIAMOND_WIDTH)*o-DIAMOND_WIDTH/2+TABLE_LEFT+BORDER_WIDTH/2,CEILING_HEIGHT+TABLE_TOP-2*TABLE_SIZE_SCALE,l,{restitution:0,shapeName:"Diamond"+(o+3),sound:WOOD_SOUND});for(var o=-1;2>=o;o++){var r=BALL_RADIUS,n=INNER_WIDTH/2+(DIAMOND_GAP+DIAMOND_WIDTH)*o-DIAMOND_WIDTH/2+TABLE_LEFT+BORDER_WIDTH/2-DIAMOND_GAP/2,s=CEILING_HEIGHT+TABLE_TOP+DIAMOND_HEIGHT/2;CreateCircle([n,s],r,{isSensor:!0,shapeName:"SensorLane"+(o+2),points:LANE_POINTS[o+1]})}var i=INNER_WIDTH/2-FIXED_BUMPER_SIZE-6;CreateCircle([TABLE_CENTER-i,CEILING_HEIGHT+LAUNCHER_DROPOFF+TABLE_TOP+46*TABLE_SIZE_SCALE],FIXED_BUMPER_SIZE,{restitution:.8,shapeName:"FixedBumper",sound:SOUND_METAL}),CreateCircle([TABLE_CENTER+i,CEILING_HEIGHT+LAUNCHER_DROPOFF+TABLE_TOP+46*TABLE_SIZE_SCALE],FIXED_BUMPER_SIZE,{restitution:.8,shapeName:"FixedBumper",sound:SOUND_METAL}),createPolygon(TABLE_CENTER-i,CEILING_HEIGHT+LAUNCHER_DROPOFF+TABLE_TOP+46*TABLE_SIZE_SCALE-FIXED_BUMPER_SIZE,[[0,0],[-FIXED_BUMPER_SIZE,0],[-FIXED_BUMPER_SIZE,-5]],{restitution:.8,shapeName:"FixedBumper",sound:SOUND_METAL}),createPolygon(TABLE_CENTER+i,CEILING_HEIGHT+LAUNCHER_DROPOFF+TABLE_TOP+46*TABLE_SIZE_SCALE-FIXED_BUMPER_SIZE,[[0,0],[FIXED_BUMPER_SIZE,-5],[FIXED_BUMPER_SIZE,0]],{restitution:.8,shapeName:"FixedBumper",sound:SOUND_METAL});var i=2*DIAMOND_WIDTH+2*DIAMOND_GAP;CreateCircle([TABLE_CENTER-i,BUMPER_TOP],POWERED_BUMPER_SIZE,{collidesWithBall:!0,force:5*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,restitution:1,points:TOP_LEFT_BUMPER_POINTS,shapeName:"LeftBumper"}),CreateCircle([TABLE_CENTER+i,BUMPER_TOP],POWERED_BUMPER_SIZE,{collidesWithBall:!0,force:5*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,restitution:1,points:TOP_RIGHT_BUMPER_POINTS,shapeName:"RightBumper"}),CreateCircle([TABLE_CENTER,BUMPER_TOP+2*POWERED_BUMPER_SIZE],POWERED_BUMPER_SIZE,{collidesWithBall:!0,force:5*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,restitution:1,points:BOTTOM_BUMPER_POINTS,shapeName:"BottomBumper"});var i=INNER_WIDTH/2-2*BALL_RADIUS-4*TABLE_SIZE_SCALE,_=[[0,0],[3*BALL_RADIUS,2*-BALL_RADIUS],[3*BALL_RADIUS,LANDER_BOTTOM*TABLE_SIZE_SCALE+2*BALL_RADIUS],[0,LANDER_BOTTOM*TABLE_SIZE_SCALE+10]];createPolygon(TABLE_CENTER+i,SIDE_LANES_TOP,[[0,0],[-_[3][0],_[3][1]],[-_[2][0],_[2][1]],[-_[1][0],_[1][1]]],{shapeName:"LaneRight",sound:WOOD_SOUND}),createPolygon(TABLE_CENTER-i,SIDE_LANES_TOP,_,{shapeName:"LaneLeft",sound:WOOD_SOUND}),CreateCircle([TABLE_CENTER+i+BALL_RADIUS,SIDE_LANES_TOP+20],BALL_RADIUS,{isSensor:!0,shapeName:"SideLaneTopRight"}),CreateCircle([TABLE_CENTER-i-BALL_RADIUS,SIDE_LANES_TOP+20],BALL_RADIUS,{isSensor:!0,shapeName:"SideLaneTopLeft"}),CreateCircle([TABLE_CENTER+i+BALL_RADIUS,SIDE_LANES_TOP+LANDER_BOTTOM*TABLE_SIZE_SCALE],BALL_RADIUS,{isSensor:!0,shapeName:"SideLaneBottomRight"}),CreateCircle([TABLE_CENTER-i-BALL_RADIUS,SIDE_LANES_TOP+LANDER_BOTTOM*TABLE_SIZE_SCALE],BALL_RADIUS,{isSensor:!0,shapeName:"SideLaneBottomLeft"});var i=INNER_WIDTH/2-2*BALL_RADIUS-4*TABLE_SIZE_SCALE-3*BALL_RADIUS-15*TABLE_SIZE_SCALE,E=39,u=28,p=SIDE_LANES_TOP+LANDER_BOTTOM-E/2-8*TABLE_SIZE_SCALE;createPolygon(TABLE_CENTER-i,p,[[0,0],[u*TABLE_SIZE_SCALE,E/2*TABLE_SIZE_SCALE],[0,E*TABLE_SIZE_SCALE]],{collidesWithBall:!0,force:15*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,shapeName:"LeftPoweredTriangle",sound:SOUND_METAL}),createPolygon(TABLE_CENTER+i,p,[[0,0],[0,E*TABLE_SIZE_SCALE],[-u*TABLE_SIZE_SCALE,E/2*TABLE_SIZE_SCALE]],{collidesWithBall:!0,force:15*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,shapeName:"RightPoweredTriangle",sound:SOUND_METAL}),createPolygon(TABLE_CENTER-(INNER_WIDTH/2-BORDER_WIDTH/2),TRIANGLE_TOP,[[0,0],[30*TABLE_SIZE_SCALE,20*TABLE_SIZE_SCALE],[0,30*TABLE_SIZE_SCALE]],{restitution:.8,shapeName:"TriangleLaneLeft",sound:WOOD_SOUND}),createPolygon(TABLE_CENTER+(INNER_WIDTH/2-BORDER_WIDTH/2),TRIANGLE_TOP,[[0,0],[0,30*TABLE_SIZE_SCALE],[-30*TABLE_SIZE_SCALE,20*TABLE_SIZE_SCALE]],{restitution:.8,shapeName:"TriangleLaneRight",sound:WOOD_SOUND});var i=INNER_WIDTH/2-BORDER_WIDTH/2-2*BALL_RADIUS-4;createPolygon(TABLE_CENTER-i,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT,[[0,0],[59,0],[i-FLIPPER_SIZE+20,FLIPPER_HEIGHT],[i-FLIPPER_SIZE,FLIPPER_AREA_HEIGHT],[0,FLIPPER_AREA_HEIGHT]],{restitution:.3,shapeName:"LanderLeft",sound:WOOD_SOUND}),createPolygon(TABLE_CENTER+i,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT,[[-59,0],[0,0],[0,FLIPPER_AREA_HEIGHT],[-(i-FLIPPER_SIZE),FLIPPER_AREA_HEIGHT],[-(i-FLIPPER_SIZE+20),FLIPPER_HEIGHT]],{restitution:.3,shapeName:"LanderRight",sound:WOOD_SOUND}),createPolygon(TABLE_CENTER-i,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT,[[0,0],[0,-20],[30,-35],[59,-30],[59,0]],{restitution:.3,shapeName:"LanderLeft",sound:WOOD_SOUND}),createPolygon(TABLE_CENTER+i-59,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT,[[0,0],[0,-30],[30,-35],[59,-20],[59,0]],{restitution:.3,shapeName:"LanderRight",sound:WOOD_SOUND}),FLIPPER_RIGHT_DRAW_POS_X=TABLE_CENTER+FLIPPER_SIZE-15*TABLE_SIZE_SCALE,FLIPPER_LEFT_DRAW_POS_X=TABLE_CENTER-FLIPPER_SIZE+15*TABLE_SIZE_SCALE,FLIPPER_RIGHT_DRAW_POS_Y=TABLE_BOTTOM-FLIPPER_AREA_HEIGHT+FLIPPER_HEIGHT+11*TABLE_SIZE_SCALE,FLIPPER_LEFT_DRAW_POS_Y=FLIPPER_RIGHT_DRAW_POS_Y,leftFlipperJoint=createFlipper([FLIPPER_LEFT_DRAW_POS_X,FLIPPER_LEFT_DRAW_POS_Y],[[0,-14],[52*TABLE_SIZE_SCALE,15*TABLE_SIZE_SCALE],[52*TABLE_SIZE_SCALE,26*TABLE_SIZE_SCALE],[0,10*TABLE_SIZE_SCALE]],!0),leftFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH),rightFlipperJoint=createFlipper([FLIPPER_RIGHT_DRAW_POS_X,FLIPPER_RIGHT_DRAW_POS_Y],[[0,-14],[0,10*TABLE_SIZE_SCALE],[-52*TABLE_SIZE_SCALE,26*TABLE_SIZE_SCALE],[-52*TABLE_SIZE_SCALE,15*TABLE_SIZE_SCALE]],!1),rightFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH);for(var n=TABLE_CENTER,s=TABLE_BOTTOM-100*TABLE_SIZE_SCALE-BORDER_WIDTH/2,o=-2;2>=o;o++)CreateCircle([n+30.5*o*TABLE_SIZE_SCALE,s-27*Math.abs(o)*TABLE_SIZE_SCALE],BALL_RADIUS,{isSensor:!0,shapeName:"BottomSensor"+(o+3),points:BOTTOM_SENSOR_POINTS[o+2]});createPolygon(TABLE_CENTER+30*TABLE_SIZE_SCALE,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT-118*TABLE_SIZE_SCALE,[[0,0],[48*TABLE_SIZE_SCALE,22*TABLE_SIZE_SCALE],[0,62*TABLE_SIZE_SCALE]],{restitution:.3,isSensor:!0,shapeName:"RightTriangleSensor",points:TRIANGLE_SENSOR_POINTS}),createPolygon(TABLE_CENTER-30*TABLE_SIZE_SCALE,TABLE_BOTTOM-FLIPPER_AREA_HEIGHT-118*TABLE_SIZE_SCALE,[[0,0],[0,62*TABLE_SIZE_SCALE],[-48*TABLE_SIZE_SCALE,22*TABLE_SIZE_SCALE]],{restitution:.3,isSensor:!0,shapeName:"LeftTriangleSensor",points:TRIANGLE_SENSOR_POINTS})}function createFlipper(e,o,t){var a=e,n=o,r=new b2CircleDef;r.radius=2;var s=new b2BodyDef;s.allowSleep=!1,s.position.Set(-2e3,-2e3);var i=box2Ob.world.CreateBody(s);i.CreateShape(r),shapeName=t?"LeftFlipper":"RightFlipper";var l=createPolygon(a[0],a[1],n,{flipper:!0,allowSleep:!1,collidesWithBall:!0,force:0,shapeName:shapeName});t?leftFlipperBody=l:rightFlipperBody=l,l.SetMassFromShapes(),l.isBullet=!0;var _=new b2RevoluteJointDef;return _.Initialize(l,i,pixelToB2dCoords(e[0],e[1]-10)),_.userData={},t?(_.upperAngle=.315*b2Settings.b2_pi,_.lowerAngle=0):(_.upperAngle=0,_.lowerAngle=-.97),_.motorTorque=0,_.motorSpeed=0,_.enableLimit=!0,_.enableMotor=!0,box2Ob.world.CreateJoint(_)}function pixelToB2dCoords(e,o){var t={x:0,y:0};if(void 0==o){var a=e;t.y=a.y/COORDINATE_SCALE_FACTOR,t.x=a.x/COORDINATE_SCALE_FACTOR}else t.x=e/COORDINATE_SCALE_FACTOR,t.y=o/COORDINATE_SCALE_FACTOR;return t}function setupWorld(){box2Ob.aabb=new b2AABB,box2Ob.aabb.lowerBound.Set(TOP_LEFT.x,TOP_LEFT.y),box2Ob.aabb.upperBound.Set(BOTTOM_RIGHT.x,BOTTOM_RIGHT.y),box2Ob.gravity=new b2Vec2(0,GRAVITY),box2Ob.doSleep=!0,box2Ob.world=new b2World(box2Ob.aabb,box2Ob.gravity,box2Ob.doSleep),box2Ob.toString=function(){return"This is the b2d world"},debug("B2world sez: "+box2Ob)}function debug(e){debugLog+=e+"\n"}function drawWorld(e,o){pinballCanvasContext.save();for(var t=e.m_bodyList;t;t=t.m_next)for(var a=t.GetShapeList();null!=a;a=a.GetNext())drawShape(a,o);var n=55,r=61;App.sensorInfo.toggleSensors.BottomSensor1&&pinballCanvasContext.drawImage(bottomSensorLightImage,492-4*r-n+28,976-n+29,57,57),App.sensorInfo.toggleSensors.BottomSensor2&&pinballCanvasContext.drawImage(bottomSensorLightImage,492-3*r-n+28,1031-n+29,57,57),App.sensorInfo.toggleSensors.BottomSensor3&&pinballCanvasContext.drawImage(bottomSensorLightImage,492-2*r-n+28,1088-n+29,57,57),App.sensorInfo.toggleSensors.BottomSensor4&&pinballCanvasContext.drawImage(bottomSensorLightImage,492-1*r-n+28,1031-n+29,57,57),App.sensorInfo.toggleSensors.BottomSensor5&&pinballCanvasContext.drawImage(bottomSensorLightImage,492-0*r-n+28,976-n+29,57,57),App.sensorInfo.toggleSensors.RightTriangleSensor&&pinballCanvasContext.drawImage(rightTriangleLightImage,431,857),App.sensorInfo.toggleSensors.LeftTriangleSensor&&pinballCanvasContext.drawImage(leftTriangleLightImage,219,857);var s=pinballCanvasContext.globalAlpha,i=80;if(bumperTimers.LeftBumper>0&&(pinballCanvasContext.globalAlpha=bumperTimers.LeftBumper/BUMPER_LIGHT_TIME,pinballCanvasContext.drawImage(bumperHitImage,204-i,420-i)),bumperTimers.BottomBumper>0&&(pinballCanvasContext.globalAlpha=bumperTimers.BottomBumper/BUMPER_LIGHT_TIME,pinballCanvasContext.drawImage(bumperHitImage,352-i,544-i)),bumperTimers.RightBumper>0&&(pinballCanvasContext.globalAlpha=bumperTimers.RightBumper/BUMPER_LIGHT_TIME,pinballCanvasContext.drawImage(bumperHitImage,500-i,420-i)),App.qualitySetting>QUALITY_NOLIGHTS)for(var l=0;App.lightsToShow.length>l;l++)if(App.lightsToShow[l].colour>=0&&0>=App.lightsToShow[l].delay){var _=App.lightsToShow[l].duration/App.lightsToShow[l].fadeStartsAt;_=Math.min(1,Math.max(_,0)),pinballCanvasContext.globalAlpha=_,pinballCanvasContext.drawImage(lightImages[App.lightsToShow[l].colour],App.lightsToShow[l].pos[0]-14,App.lightsToShow[l].pos[1]-14)}pinballCanvasContext.globalAlpha=s,App.explosionTimer>=0&&0==Math.floor(App.explosionTimer/5)%2&&pinballCanvasContext.drawImage(explosionImage1,533,191),pinballCanvasContext.scale(-1,1),App.explosionTimer>=0&&0==Math.floor(App.explosionTimer/5)%2&&pinballCanvasContext.drawImage(explosionImage1,-210,191),pinballCanvasContext.restore()}function b2dToPixelCoords(e,o){var t={x:0,y:0};if(void 0==o){var a=e;t.y=a.y*COORDINATE_SCALE_FACTOR,t.x=a.x*COORDINATE_SCALE_FACTOR}else{var n=e;t.x=n*COORDINATE_SCALE_FACTOR,t.y=o*COORDINATE_SCALE_FACTOR}return t}function drawShape(e,o){if(debugMode||null!=e.m_userData&&1==e.m_userData.drawShape){switch(o.strokeStyle=e.m_userData&&e.m_userData.isSensor?"#F00":"#000",o.beginPath(),e.m_type){case b2Shape.e_circleShape:var t=e,a=t.m_body.GetWorldCenter(),n=b2dToPixelCoords(a.x,a.y),r=b2dToPixelCoords(t.m_radius,t.m_radius).x;o.arc(n.x,n.y,r,0,2*Math.PI,!1);break;case b2Shape.e_polygonShape:var s=e.m_body.m_xf,i=e,l=b2Math.AddVV(s.position,b2Math.b2MulMV(s.R,e.m_vertices[0])),_=b2dToPixelCoords(l);o.moveTo(_.x,_.y);var E=!1;void 0==e.m_userData||"LFlipperPoly"!=e.m_userData.shapeName&&"RFlipperPoly"!=e.m_userData.shapeName||(E=!0);for(var u=0;i.m_vertexCount>u;u++){var p=b2Math.AddVV(s.position,b2Math.b2MulMV(s.R,e.m_vertices[u])),d=b2dToPixelCoords(p);E&&2==u?o.moveTo(d.x,d.y):o.lineTo(d.x,d.y)}o.lineTo(_.x,_.y)}o.stroke()}}function resetPointTrackers(){App.lastSensor=null,void 0==App.sensorInfo.leftTracker&&(App.sensorInfo.leftTracker=0,App.sensorInfo.rightTracker=0,App.sensorInfo.toggleSensors={},App.sensorInfo.toggleSensors.BottomSensor1=!1,App.sensorInfo.toggleSensors.BottomSensor2=!1,App.sensorInfo.toggleSensors.BottomSensor3=!1,App.sensorInfo.toggleSensors.BottomSensor4=!1,App.sensorInfo.toggleSensors.BottomSensor5=!1,App.sensorInfo.toggleSensors.RightTriangleSensor=!1,App.sensorInfo.toggleSensors.LeftTriangleSensor=!1)}function AddDecorativeLight(e,o,t,a,n){App.lightsToShow.push({colour:e,pos:o,delay:t,duration:a,fadeStartsAt:n})}function createBall(e,o,t,a,n,r){var s=new b2CircleDef;n||(s.density=1),s.radius=(a||BALL_RADIUS)/COORDINATE_SCALE_FACTOR,s.restitution=.5,s.friction=.01,s.userData=null!=r?{shapeName:r}:{shapeName:"TheBall"};var i=new b2BodyDef;i.position.Set(o,t);var l=e.CreateBody(i);return l.isBullet=!0,l.CreateShape(s),l.SetMassFromShapes(),l}function Initialize(){pinballCanvas=document.getElementById("pinballCanvas"),pinballCanvasContext=pinballCanvas.getContext("2d"),backgroundImages=[],backgroundImages[0]=new Image,backgroundImages[0].src=BACKGROUND_URL,ballImage=new Image,ballImage.src="img/Tommy_Ball_1.png",sensorImage=new Image,sensorImage.src="img/SensorOn.png",bumperHitImage=new Image,bumperHitImage.src="img/BumperHit.png",leftTriangleLightImage=new Image,rightTriangleLightImage=new Image,leftTriangleLightImage.src="img/Triangle_Left.png",rightTriangleLightImage.src="img/Triangle_Right.png",bottomSensorLightImage=new Image,bottomSensorLightImage.src="img/SensorLight.png",plateImage=new Image,plateImage.src="img/Plate.png",arrowImage=new Image,arrowImage.src="img/Arrow_ON.png",explosionImage1=new Image,explosionImage1.src="img/ReversedExplosion.png",explosionImage2=new Image,explosionImage2.src="img/Explosion_3.png",lightImages[LIGHT_COLOUR_BLUE].src="img/BlueLight_ON.png",lightImages[LIGHT_COLOUR_BLUE_OFF].src="img/BlueLight_OFF.png",lightImages[LIGHT_COLOUR_RED].src="img/RedLight_ON.png",lightImages[LIGHT_COLOUR_RED_OFF].src="img/RedLight_OFF.png",lightImages[LIGHT_COLOUR_GREEN].src="img/GreenLight_ON.png",lightImages[LIGHT_COLOUR_GREEN_OFF].src="img/GreenLight_OFF.png",lightImages[LIGHT_COLOUR_BLUE_ARROW].src="img/BlueArrowLight.png",leftFlipperImage=new Image,leftFlipperImage.src="img/Flipper_Left.png",rightFlipperImage=new Image,rightFlipperImage.src="img/Flipper_Right.png",Sounds.Initialize(),preload(["img/Play_Hover.png","img/PlayAgain_Hover.png","img/Submit_Hover.png","img/ShareScore_Hover.png","img/Twitter_Hover.png","img/YouTube_Hover.png","img/Facebook_Hover.png","img/Mail_Hover.png","img/BuyTixRound_Hover.png","img/BuyTix_Hover.png","img/Start_Hover.png","img/QualityLow.png","img/QualityMedium.png"])}function preload(e){$(e).each(function(){$("<img/>")[0].src=this})}function UpdateHighScores(){var e=0;$(".endGame .highScore .endScoreWrapper").each(function(){highScoreObject.length>e&&($(this).find(".scoreParagraph").html(convertScore(highScoreObject[e].score)),$(this).find(".nameParagraph").html(highScoreObject[e].tag)),e++}),$(".mainGameHighScore .scoreContainer .scoreParagraph").html(convertScore(highScoreObject[0].score)),$(".mainGameHighScore .scoreNameContainer").html("Hi Score: "+highScoreObject[0].tag)}function CloseShareLightbox(){$("#shareLightbox").fadeOut(200)}function PlayAgainInLightboxClicked(){CloseShareLightbox(),StartGame()}function FlashItYellow(e){$(".endGame .yourScore .scoreNameContainer, .endGame .yourScore .scoreParagraph").css("color","#ffe000"),window.setTimeout(function(){FlashItWhite(e-1)},200)}function FlashItWhite(e){$(".endGame .yourScore .scoreNameContainer, .endGame .yourScore .scoreParagraph").css("color","white"),e>0&&window.setTimeout(function(){FlashItYellow(e)},200)}function GameOver(){Sounds.FadeOutMusic(10,function(){Sounds.StartMusic("EndGameMusic"),Sounds.fadeOverrideable=!0,Sounds.FadeInMusic(1)}),Sounds.fadeOverrideable=!1,$(".main-container").fadeOut(1e3,function(){$("html").removeClass("gamePlayStarted").addClass("gameOver"),$("footer#mainFooter").addClass("gameOver"),$(".main-container").css("display","block"),$(".showDuringGame").addClass("hidden"),$(".hideDuringGame").addClass("hidden"),$(".main.wrapper").addClass("hidden"),_gaq.push(["_trackEvent","GameEnded",sc]),sc>highScoreObject[1].score?($("#discountAmount").html(hiDiscount).addClass("hiScore"),$("#discountCode").html(hiDiscountCode).addClass("hiScore"),$("#buyTicketsButton a").attr("href",hiUrl)):$("#discountAmount").hasClass("hiScore")||($("#discountAmount").html(lowDiscount),$("#discountCode").html(lowDiscountCode),$("#buyTicketsButton a").attr("href",lowUrl)),window.setTimeout(function(){FlashItYellow(10)},200),show_palooza_ad&&$(".pinballoozaHolder").css("display","block"),$(".showDuringEnd").removeClass("hidden"),$("#tableContainer").css("top","0"),$(".header-container").height("235px"),$(".shareScoreButton").click(function(){$("#shareLightbox .scoreParagraph").html(convertScore(sc)),$("#shareLightbox").fadeIn(200),$("#shareLightbox .twitter").attr("href","https://twitter.com/share?text=I%20just%20scored%20"+convertScore(sc)+"%20on%20@stratfest's%20%23sfTommy%20Pinball%20game%20-%20top%20that%20at"+"&url=http%3A%2F%2Fwww.tommypinball.com"),$("#shareLightbox .email").attr("href","mailto:?subject=Beat my Tommy Pinball score!&body=I%20just%20scored%20"+convertScore(sc)+"%20on%20the%20Stratford%20Festival's%20Tommy%20Pinball%20game%20-%20top%20that%20at%20http%3A//www.tommypinball.com"),$("#shareLightbox .facebook").attr("href","https://www.facebook.com/dialog/feed?app_id=117650835093485&redirect_uri=http://www.tommypinball.com/&link=http://www.tommypinball.com/&picture=http://www.tommypinball.com/images/TommyShare1.png&name=Tommy%20Pinball%20Game&caption=Tommy%20Pinball%20Game&description=I%20just%20scored%20"+convertScore(sc)+"%20on%20the%20Stratford%20Festival's%20Tommy%20Pinball%20game%20-%20top%20that%20at%20http%3A//www.tommypinball.com")}),$("#buyTicketsButton").click(function(){}),$(window).resize(function(){$(".page-container").css("height","auto").css("overflow","visible");var e=235,o=$(".footer-container").height(),t=$(window).height(),a=t-e-o;$(".main.endGame").css("height",a),$("header").css("height",e+"px");var n=$(".endGame.wrapper").offset().left;$(".header-container").css("background-position",n-378+107-29+"px 2px"),$(".footer-container").css("background-position",n-378+107-29+"px "+(-846+(556-a)+"px")),$(".endGame .backgroundHolder").css("background-position",n-378+107-29+"px -233px")}),$(".inner-page-container").css("position","relative").stop().animate({top:0}),$(window).resize(),gameStarted=!1,document.addEventListener("keydown",GameOverKeyDown,!1),blinkNameEntryInterval=window.setInterval(BlinkNameEntry,500)})}function BlinkNameEntry(){blinkingUnderscoreVisible=!blinkingUnderscoreVisible,UpdateHighScoreName()}function UpdateHighScoreName(){for(var e=highScoreName,o=0;3-highScoreName.length>o;o++)e+=o>0||blinkingUnderscoreVisible?"_":"&nbsp;";$("#enterYourName").html(e)}function scoreSubmitSuccess(e){e=jQuery.parseJSON(e),e&&(highScoreObject=e),UpdateHighScores()}function SubmitScore(){if(!scoreSubmitted&&3==highScoreName.length){$(".submitButton").addClass("disabled"),scoreSubmitted=!0,""==highScoreName&&(highScoreName="TOM",UpdateHighScoreName()),sc!=lS&&(cD=!0);var e={tag:highScoreName+(cD?"!":""),score:sc,hits:JSON.stringify(pointsHit)},o="/saveScore.php";-1!=window.location.href.indexOf("jmp-dev.rtraction")&&(o="/tommy"+o),$.post(o,e,scoreSubmitSuccess)}}function PlayAgainClick(){StartGame()}function GameOverKeyDown(e){return(e.keyCode>=65&&90>e.keyCode||e.keyCode>=48&&57>=e.keyCode)&&3>highScoreName.length&&(highScoreName+=String.fromCharCode(e.keyCode)),8==e.keyCode&&highScoreName.length>0&&(highScoreName=highScoreName.slice(0,highScoreName.length-1)),3!=highScoreName.length||scoreSubmitted?$(".submitButton").addClass("disabled"):$(".submitButton").removeClass("disabled"),13==e.keyCode&&SubmitScore(),UpdateHighScoreName(),8==e.keyCode?(e.returnValue=!1,!1):void 0}function ShowInstructions(){$("html").removeClass("intro").addClass("instructions"),$(".hideDuringGame").addClass("hidden"),$(".instructionsDiv").removeClass("hidden"),$("#bgImage").removeClass("hidden")}function StartGame(){_gaq.push(["_trackEvent","GameEnded"]),Sounds.sounds.backgroundMusic?(Sounds.FadeOutMusic(10,function(){Sounds.StartMusic("BGMusic"),Sounds.fadeOverrideable=!0,Sounds.FadeInMusic(1)}),Sounds.fadeOverrideable=!1):Sounds.StartMusic("BGMusic"),null!=blinkNameEntryInterval&&clearInterval(blinkNameEntryInterval),UpdateHighScores(),$(".main.wrapper").removeClass("hidden"),$(".main.endGame").removeClass("hidden"),$(".hideDuringGame").addClass("hidden"),$(".instructionsDiv").addClass("hidden"),$(".showDuringGame").removeClass("hidden"),$(".header-container").height("411px"),$("footer#mainFooter").removeClass("gameOver"),$("html").removeClass("instructions").removeClass("gameOver").addClass("gamePlayStarted"),gameStarted=!0,sc=0,cD=!1,scoreSubmitted=!1,lS=0,lL=5,updateScore(),updateLifeDisplay(),delete App.sensorInfo,delete App.sensorsPressed,delete App.lastSensorsPressed,delete App.lightsToShow,App.sensorInfo={},App.sensorsPressed={},App.lastSensorsPressed={},App.lightsToShow=[],App.explosionTimer=-1,$(window).resize(function(){$(".page-container").css("height",$(window).height()-1+"px").css("overflow","hidden");var e=$("#pinballCanvas").offset().left;$(".header-container").css("background-position",e-378+"px 2px"),$(".footer-container").css("background-position",e-378+"px -846px");var o=$(".header-container").height();gameStarted&&(o=$(".header-container").height()-HEADER_SCROLL_DURING_GAMEPLAY);var t=$(".footer-container").height(),a=$(window).height();$("#tableWrapper").css("height",a-o-t)}),$(".inner-page-container").css("position","relative").stop().animate({top:-HEADER_SCROLL_DURING_GAMEPLAY}),$(window).resize(),resetPointTrackers(),pointsHit={},currentBall=createBall(box2Ob.world,LAUNCHER_SPAWN_POINT.x,LAUNCHER_SPAWN_POINT.y,BALL_RADIUS,!1),document.addEventListener("keydown",KeyDown,!1),"ontouchstart"in document?(document.addEventListener("touchstart",WindowMouseDown,!1),document.addEventListener("touchend",WindowMouseUp,!1)):(document.addEventListener("mousedown",WindowMouseDown,!1),document.addEventListener("mouseup",WindowMouseUp,!1)),document.addEventListener("keyup",KeyUp,!1),setTimeout(mainLoop,17);for(var e=0;14>e;e++)(3>e||e>7)&&AddDecorativeLight(LIGHT_COLOUR_RED_OFF,[373,663+25*e],0,99999999999,0);AddDecorativeLight(LIGHT_COLOUR_RED_OFF,[129,784],0,99999999999,0),AddDecorativeLight(LIGHT_COLOUR_RED_OFF,[211,784],0,99999999999,0),AddDecorativeLight(LIGHT_COLOUR_RED_OFF,[533,784],0,99999999999,0),AddDecorativeLight(LIGHT_COLOUR_RED_OFF,[615,784],0,99999999999,0);for(var o=16,e=0;6>e;e++)3!=e&&AddDecorativeLight(LIGHT_COLOUR_BLUE_OFF,[205-2*o*e,713-o*e],0,99999999999,0);for(var e=0;8>e;e++)AddDecorativeLight(LIGHT_COLOUR_BLUE_OFF,[480+2*o*e,713-o*e],0,99999999999,0);for(var e=0;7>e;e++)AddDecorativeLight(LIGHT_COLOUR_BLUE_OFF,[270-2*o*e,849+o*e],0,99999999999,0);for(var e=0;6>e;e++)3!=e&&4!=e&&AddDecorativeLight(LIGHT_COLOUR_BLUE_OFF,[529+2*o*e,848+o*e],0,99999999999,0)}function mainLoop(){var e=1/45;gameStarted&&(logicTick(),handleCollisions(),launcherForceTimer>0&&(launcherForceTimer-=1,0>=launcherForceTimer&&(launcher.m_shapeList.m_userData.force=0)),doScoring(),handleInput(),box2Ob.world.Step(e,3),drawBackground(),drawWorld(box2Ob.world,pinballCanvasContext),drawFlippers(),flashTimer+=1,flashTimer>=2*flashOnTime&&(flashTimer=0),null!=currentBall&&currentBall.m_xf.position.x>38.2&&0==Math.floor(flashTimer/flashOnTime)%2&&pinballCanvasContext.drawImage(arrowImage,753,1079,21,73),drawBall(),pinballCanvasContext.drawImage(plateImage,725,852),scrollWorld()),gameStarted&&setTimeout(mainLoop,17)}function drawBackground(){pinballCanvasContext.drawImage(backgroundImages[currentBackground],0,0)}function turnOnAllToggleSensors(){for(var e=0;ALL_TOGGLE_SENSOR_LIST.length>e;e++)App.sensorInfo.toggleSensors[ALL_TOGGLE_SENSOR_LIST[e]]=!0}function turnOffAllToggleSensors(){for(var e=0;ALL_TOGGLE_SENSOR_LIST.length>e;e++)App.sensorInfo.toggleSensors[ALL_TOGGLE_SENSOR_LIST[e]]=!1}function turnOnToggleSensor(e){void 0!=App.sensorInfo.toggleSensors[e]?App.sensorInfo.toggleSensors[e]=!0:alert("ERROR: sensor "+e+" is not a toggle sensor")}function FlashCenter(){for(var e=0;6>e;e++){for(var o=0;14>o;o++)(3>o||o>7)&&AddDecorativeLight(LIGHT_COLOUR_RED,[373,663+25*o],20*e,15,15);AddDecorativeLight(LIGHT_COLOUR_RED,[129,784],20*e,15,15),AddDecorativeLight(LIGHT_COLOUR_RED,[211,784],20*e,15,15),AddDecorativeLight(LIGHT_COLOUR_RED,[533,784],20*e,15,15),AddDecorativeLight(LIGHT_COLOUR_RED,[615,784],20*e,15,15);var t=16;if(0==e%2)for(var o=0;6>o;o++)3!=o&&AddDecorativeLight(LIGHT_COLOUR_BLUE,[205-2*t*o,713-t*o],20*e+5*o,15,15);if(0==e%2)for(var o=0;8>o;o++)AddDecorativeLight(LIGHT_COLOUR_BLUE,[480+2*t*o,713-t*o],20*e+5*o,15,15);if(0==e%2)for(var o=0;7>o;o++)AddDecorativeLight(LIGHT_COLOUR_BLUE,[270-2*t*o,849+t*o],20*e+5*o,15,15);if(0==e%2)for(var o=0;6>o;o++)3!=o&&4!=o&&AddDecorativeLight(LIGHT_COLOUR_BLUE,[529+2*t*o,848+t*o],20*e+5*o,15,15)}}function doScoring(){for(sensorName in App.sensorsPressed)if(void 0==App.lastSensorsPressed[sensorName]){var e=App.sensorsPressed[sensorName];switch(sensorName){case"SideLaneTopLeft":case"SideLaneTopRight":break;case"SideLaneBottomLeft":if("SideLaneTopLeft"==App.lastSensor)switch(Sounds.PlaySound("Siren"),App.sensorInfo.leftTracker+=1,App.sensorInfo.leftTracker){case 1:turnOnToggleSensor("BottomSensor5"),FlashCenter();break;case 2:turnOnToggleSensor("BottomSensor4"),FlashCenter();break;case 3:App.sensorInfo.leftTracker>=3&&App.sensorInfo.rightTracker>=3?(turnOnAllToggleSensors(),App.sensorInfo.leftTracker=0,App.sensorInfo.rightTracker=0):turnOnToggleSensor("BottomSensor3"),FlashCenter();break;default:turnOnToggleSensor("LeftTriangleSensor"),App.sensorInfo.leftTracker=3}break;case"BottomSensor1":break;case"SideLaneBottomRight":if("SideLaneTopRight"==App.lastSensor)switch(Sounds.PlaySound("Siren"),App.sensorInfo.rightTracker+=1,App.sensorInfo.rightTracker){case 1:turnOnToggleSensor("BottomSensor1"),FlashCenter();break;case 2:turnOnToggleSensor("BottomSensor2"),FlashCenter();break;case 3:App.sensorInfo.leftTracker>=3&&App.sensorInfo.rightTracker>=3?(turnOnAllToggleSensors(),App.sensorInfo.leftTracker=0,App.sensorInfo.rightTracker=0):turnOnToggleSensor("BottomSensor3"),FlashCenter();break;default:turnOnToggleSensor("RightTriangleSensor"),App.sensorInfo.rightTracker=3}break;case"SensorLane1":case"SensorLane2":case"SensorLane3":case"SensorLane4":Sounds.PlaySound("TopLanes");break;default:0==App.sensorsPressed[sensorName]&&alert("UNKNOWN BEHAVIOUR FOR SENSOR: "+sensorName)}(void 0==App.sensorInfo.toggleSensors[sensorName]||1==App.sensorInfo.toggleSensors[sensorName])&&(void 0!=App.sensorInfo.toggleSensors[sensorName]&&(App.sensorInfo.toggleSensors[sensorName]=!1),App.lastSensor=sensorName,pointsHit.hasOwnProperty(sensorName)||(pointsHit[sensorName]=0),pointsHit[sensorName]+=1,addScore(e),("BottomSensor1"==sensorName||"BottomSensor2"==sensorName||"BottomSensor3"==sensorName||"BottomSensor4"==sensorName||"BottomSensor5"==sensorName||"RightTriangleSensor"==sensorName||"LeftTriangleSensor"==sensorName)&&Sounds.PlaySound("Ding3"))}}function addScore(e){lL>0&&(sc+=e,updateScore())}function updateScore(){$(".yourScore .scoreParagraph").html(convertScore(sc))}function updateLifeDisplay(){for(var e=1;5>=e;e++)e>lL?$(".lifeLight"+e).addClass("off"):$(".lifeLight"+e).removeClass("off")}function convertScore(e){var o=""+Math.min(e,999999);return o.length>3&&(o=o.substring(0,o.length-3)+","+o.substring(o.length-3,o.length)),o}function drawBall(){currentBall&&pinballCanvasContext.drawImage(ballImage,currentBall.m_xf.position.x*COORDINATE_SCALE_FACTOR-BALL_RADIUS,currentBall.m_xf.position.y*COORDINATE_SCALE_FACTOR-BALL_RADIUS)}function drawFlippers(){pinballCanvasContext.save(),pinballCanvasContext.translate(FLIPPER_RIGHT_DRAW_POS_X,FLIPPER_RIGHT_DRAW_POS_Y),pinballCanvasContext.rotate(-.35-rightFlipperJoint.GetJointAngle()),pinballCanvasContext.drawImage(rightFlipperImage,-117,-17),pinballCanvasContext.restore(),pinballCanvasContext.save(),pinballCanvasContext.translate(FLIPPER_LEFT_DRAW_POS_X,FLIPPER_LEFT_DRAW_POS_Y),pinballCanvasContext.rotate(.35-leftFlipperJoint.GetJointAngle()),pinballCanvasContext.drawImage(leftFlipperImage,-17,-17),pinballCanvasContext.restore()}function logicTick(){if(sideLightTimer>=SIDE_LIGHT_LOOP_TIME&&null!=currentBall&&currentBall.m_xf.position.x>38.2){sideLightTimer=0;for(var e=0;29>e;e++)AddDecorativeLight(LIGHT_COLOUR_RED,[762.5,1055-20*e],3*e,30,15)}if(sideLightTimer+=SIDE_LIGHT_LOOP_TIME>sideLightTimer?1:0,null!=currentBall){if(3>App.sensorInfo.rightTracker&&0==lineLightTimer%(LANE_LIGHT_LOOP_TIME/(1+App.sensorInfo.rightTracker)))for(var e=0;6>e;e++)AddDecorativeLight(Math.floor(LIGHT_COLOUR_BLUE_ARROW),[701,704+31.2*e],e*(5-App.sensorInfo.rightTracker),20,20);if(3>App.sensorInfo.leftTracker&&0==lineLightTimer%(LANE_LIGHT_LOOP_TIME/(1+App.sensorInfo.leftTracker)))for(var e=0;6>e;e++)AddDecorativeLight(Math.floor(LIGHT_COLOUR_BLUE_ARROW),[26,704+31.2*e],e*(5-App.sensorInfo.leftTracker),20,20)}lineLightTimer+=1,lineLightTimer>=LANE_LIGHT_LOOP_TIME&&(lineLightTimer=0),null!=currentBall&&null==rampBlocker&&currentBall.m_xf.position.x<pixelToB2dCoords(700,0).x&&createRampBlocker(),null!=currentBall&&currentBall.m_linearVelocity.y>50&&(currentBall.m_linearVelocity.y=50);for(var o in bumperTimers)bumperTimers[o]>0&&(bumperTimers[o]-=1);App.explosionTimer>=0&&(App.explosionTimer+=1,App.explosionTimer>EXPLOSION_TIME&&(App.explosionTimer=-1));
for(var e=0;App.lightsToShow.length>e;)App.lightsToShow[e].delay>0?App.lightsToShow[e].delay-=1:App.lightsToShow[e].duration-=1,0>=App.lightsToShow[e].duration?App.lightsToShow.splice(e,1):e+=1;Math.abs(lS-sc)>2e3&&(cD=!0),lS=sc}function scrollWorld(){if(currentBall){var e=$("#tableWrapper").height(),o=-b2dToPixelCoords(currentBall.m_xf.position).y+e/2;o=Math.max(o,-TABLE_HEIGHT*TABLE_SIZE_SCALE+e),o=Math.min(o,0),$("#tableContainer").css("top",o),App.qualitySetting>QUALITY_NOSCROLL&&(parallaxTop=Math.round(o/8),$(".main-container").css("background-position","0px "+parallaxTop+"px"),$(".leftGreenLight, .rightGreenLight").css("top",2*parallaxTop+"px"))}}function handleInput(){if(KEYlauncherPressed){launcherTimer=Math.max(0,Math.min(MAX_LAUNCHER_TIMER,launcherTimer+1));var e=launcherTimer/MAX_LAUNCHER_TIMER,o=Math.round(60*(1-e)),t=Math.round(60*e);$("#plunger").css("height",o+31+"px").css("top",t+"px")}}function preventDefault(e){e=e||window.event,e.preventDefault&&e.preventDefault(),e.returnValue=!1}function LeftFlip(e,o){e?(leftFlipperJoint.SetMotorSpeed(FLIPPER_STRENGTH),leftFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH),KEYleftFlipperPressed||o||Sounds.PlaySound("Flipper"),KEYleftFlipperPressed=!0):(leftFlipperJoint.SetMotorSpeed(-1*FLIPPER_STRENGTH),leftFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH),KEYleftFlipperPressed=!1)}function RightFlip(e,o){e?(rightFlipperJoint.SetMotorSpeed(-0.9*FLIPPER_STRENGTH),rightFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH),KEYrightFlipperPressed||o||Sounds.PlaySound("Flipper"),KEYrightFlipperPressed=!0):(rightFlipperJoint.SetMotorSpeed(FLIPPER_STRENGTH),rightFlipperJoint.SetMaxMotorTorque(FLIPPER_STRENGTH),KEYrightFlipperPressed=!1)}function WindowMouseUp(e){if(null!=e.touches){for(var o=!1,t=!1,a=e.touches.length,n=0;a>n;n++)e.touches[n].pageX<window.innerWidth/2?o=!0:t=!0;o||LeftFlip(0),t||RightFlip(0),0>=a&&LauncherReleased()}}function WindowMouseDown(e){if(null!=e.touches){if(e.touches.length>0){for(var o=e.touches.length,t=0;o>t;t++)e.touches[t].pageX<window.innerWidth/2?KEYleftFlipperPressed||LeftFlip(1):KEYrightFlipperPressed||RightFlip(1);KEYlauncherPressed=!0}}}function KeyDown(e){(37==e.keyCode||65==e.keyCode||90==e.keyCode)&&LeftFlip(1),(39==e.keyCode||68==e.keyCode||191==e.keyCode)&&RightFlip(1),(40==e.keyCode||32==e.keyCode)&&(KEYlauncherPressed=!0)}function LauncherReleased(){if(KEYlauncherPressed=!1,void 0!=launcher){var e=32+40*(launcherTimer/MAX_LAUNCHER_TIMER)+Math.random();launcher.m_shapeList.m_userData.force=e*TABLE_SIZE_SCALE*TABLE_SIZE_SCALE,launcherForceTimer=10}launcherTimer=0,$("#plunger").css("height","91px").css("top","0px"),$("#plunger").hide(0,function(){$("#plunger").show(0)})}function KeyUp(e){(37==e.keyCode||65==e.keyCode||90==e.keyCode)&&LeftFlip(0),(39==e.keyCode||68==e.keyCode||191==e.keyCode)&&RightFlip(0),(40==e.keyCode||32==e.keyCode)&&LauncherReleased()}function handleCollisions(){App.lastSensorsPressed=App.sensorsPressed,App.sensorsPressed={},App.lastObjectHit=App.objectHit,App.objectHitTimeout>0&&(App.objectHitTimeout-=1),0>=App.objectHitTimeout&&""!=App.objectHit&&(App.objectHit="");for(var e="",o=box2Ob.world.m_contactList;o;o=o.m_next)if(o.m_manifold.pointCount>0&&null!=o.m_shape1.m_userData&&null!=o.m_shape2.m_userData){var t=null,a=null;if((o.m_shape1.m_userData.collidesWithBall||o.m_shape1.m_userData.sound||o.m_shape1.m_userData.isSensor)&&"TheBall"==o.m_shape2.m_userData.shapeName&&(t=o.m_shape2,a=o.m_shape1),(o.m_shape2.m_userData.collidesWithBall||o.m_shape2.m_userData.sound||o.m_shape2.m_userData.isSensor)&&"TheBall"==o.m_shape1.m_userData.shapeName&&(t=o.m_shape1,a=o.m_shape2),null!=t)if(a.m_userData&&a.m_userData.isSensor){if(a.m_userData.shapeName){var n=0;void 0!=a.m_userData.points&&(n+=a.m_userData.points),App.sensorsPressed[a.m_userData.shapeName]=n}"SensorLane1"!=a.m_userData.shapeName&&"SensorLane2"!=a.m_userData.shapeName&&"SensorLane3"!=a.m_userData.shapeName&&"SensorLane4"!=a.m_userData.shapeName||-1!=App.explosionTimer||(App.explosionTimer=0)}else if(a.m_userData){a.m_userData.shapeName&&a.m_userData.sound&&(App.objectHit=a.m_userData.shapeName,App.objectHitTimeout=3,e=a.m_userData.sound);var r=t.m_body.m_xf.position;if(void 0!=a.m_userData.force){"Launcher"==a.m_userData.shapeName&&0!=launcherTimer&&(currentBall.m_linearVelocity.y=0);var s=32;s=a.m_userData.force,"RightFlipper"==a.m_userData.shapeName&&KEYrightFlipperPressed&&rightFlipperJoint.GetJointAngle()<rightFlipperJoint.GetUpperLimit()&&rightFlipperJoint.GetJointAngle()>rightFlipperJoint.GetLowerLimit()&&(s=FLIPPER_FORCE),"LeftFlipper"==a.m_userData.shapeName&&KEYleftFlipperPressed&&leftFlipperJoint.GetJointAngle()<leftFlipperJoint.GetUpperLimit()&&leftFlipperJoint.GetJointAngle()>leftFlipperJoint.GetLowerLimit()&&(s=FLIPPER_FORCE),"Launcher"==a.m_userData.shapeName&&0!=a.m_userData.force&&Sounds.PlaySound("Launch"),t.m_body.ApplyImpulse(new b2Vec2(o.m_manifolds[0].normal.x*s,o.m_manifolds[0].normal.y*s),r)}void 0!=a.m_userData.points&&(pointsHit.hasOwnProperty(a.m_userData.shapeName)||(pointsHit[a.m_userData.shapeName]=0),pointsHit[a.m_userData.shapeName]+=1,addScore(a.m_userData.points)),("LeftBumper"==a.m_userData.shapeName||"BottomBumper"==a.m_userData.shapeName||"RightBumper"==a.m_userData.shapeName)&&(bumperTimers[a.m_userData.shapeName]=BUMPER_LIGHT_TIME,Sounds.PlaySound("Ding1")),"TheGround"==a.m_userData.shapeName&&KillYou(t)}}e&&App.lastObjectHit!=App.objectHit&&Sounds.PlaySound(e)}function KillYou(e){resetPointTrackers(),box2Ob.world.DestroyBody(rampBlocker.m_shapeList.m_body),rampBlocker=null,box2Ob.world.DestroyBody(e.m_body),lL-=1,Sounds.PlaySound("LifeLoss"),currentBall=lL>0||debugMode?createBall(box2Ob.world,LAUNCHER_SPAWN_POINT.x,LAUNCHER_SPAWN_POINT.y,BALL_RADIUS,!1):null,0==lL&&GameOver(),updateLifeDisplay()}var COORDINATE_SCALE_FACTOR=20,MAX_NUM_LIVES=5,TABLE_SIZE_SCALE=2,GRAVITY=25,BALL_RADIUS=10*TABLE_SIZE_SCALE,TABLE_HEIGHT=650,TABLE_WIDTH=400,FLIPPER_STRENGTH=2e4*TABLE_SIZE_SCALE,MAX_LAUNCHER_TIMER=50,FLIPPER_FORCE=65,FLIPPER_RIGHT_DRAW_POS_X=25,FLIPPER_RIGHT_DRAW_POS_Y=60,FLIPPER_LEFT_DRAW_POS_X=25,FLIPPER_LEFT_DRAW_POS_Y=60,HEADER_SCROLL_DURING_GAMEPLAY=240,box2Ob={},BUMPER_POINTS=20,TOP_LEFT_SENSOR_POINTS=100,LANE_POINTS=[300,300,300,300],BOTTOM_SENSOR_POINTS=[250,750,1500,500,250],TRIANGLE_SENSOR_POINTS=150,BOTTOM_BUMPER_POINTS=BUMPER_POINTS,TOP_LEFT_BUMPER_POINTS=BUMPER_POINTS,TOP_RIGHT_BUMPER_POINTS=BUMPER_POINTS,ACTUAL_TABLE_WIDTH=TABLE_WIDTH*TABLE_SIZE_SCALE,ACTUAL_TABLE_HEIGHT=TABLE_HEIGHT*TABLE_SIZE_SCALE,TABLE_TOP=1,TABLE_LEFT=1,BORDER_WIDTH=5*TABLE_SIZE_SCALE,TABLE_BOTTOM=TABLE_TOP+ACTUAL_TABLE_HEIGHT-BORDER_WIDTH,CEILING_HEIGHT=100*TABLE_SIZE_SCALE,LAUNCHER_DROPOFF=15*TABLE_SIZE_SCALE,BUMPER_TOP=220*TABLE_SIZE_SCALE,SIDE_LANES_TOP=375*TABLE_SIZE_SCALE-3*BALL_RADIUS-5*TABLE_SIZE_SCALE,TRIANGLE_TOP=460*TABLE_SIZE_SCALE,LAUNCHER_WIDTH=2*BALL_RADIUS+4*TABLE_SIZE_SCALE,INNER_WIDTH=ACTUAL_TABLE_WIDTH-LAUNCHER_WIDTH-2*BORDER_WIDTH,TABLE_CENTER=TABLE_LEFT+BORDER_WIDTH/2+INNER_WIDTH/2,FIXED_BUMPER_SIZE=18*TABLE_SIZE_SCALE,DIAMOND_WIDTH=17*TABLE_SIZE_SCALE,DIAMOND_HEIGHT=63*TABLE_SIZE_SCALE,DIAMOND_TIP_HEIGHT=9*TABLE_SIZE_SCALE,DIAMOND_GAP=2*BALL_RADIUS+0*TABLE_SIZE_SCALE,POWERED_BUMPER_SIZE=30*TABLE_SIZE_SCALE,LANDER_BOTTOM=100,FLIPPER_SIZE=80*TABLE_SIZE_SCALE,FLIPPER_AREA_HEIGHT=100*TABLE_SIZE_SCALE,FLIPPER_HEIGHT=50*TABLE_SIZE_SCALE,WOOD_SOUND="Wood2",SOUND_METAL="Metal",Sounds={};Sounds.Initialize=function Initialize(){this.soundMuted=!1,this.musicMuted=!1,this.fadingTimeout=null,this.fadingDuration=20,this.fadingTimer=0,this.backgroundVolume=0,this.volumeAtStartOfFade=0,this.fadeOverrideable=!0,this.sounds={};var e=.5;this.LoadSound({key:"Ding1",source:"sounds/Ding1",volume:.6*e,maxCopies:5}),this.LoadSound({key:"Ding2",source:"sounds/Ding2",volume:.8*e,maxCopies:5}),this.LoadSound({key:"Ding3",source:"sounds/Ding3",volume:.8*e,maxCopies:5}),this.LoadSound({key:"Wood2",source:"sounds/Wood2",volume:.3*e,maxCopies:5}),this.LoadSound({key:"Flipper",source:"sounds/FlipperUp7",volume:.6*e,maxCopies:2}),this.LoadSound({key:"LifeLoss",source:"sounds/Drain2",volume:.4*e,maxCopies:1}),this.LoadSound({key:"Launch",source:"sounds/BallRoll1",volume:.4*e,maxCopies:1}),this.LoadSound({key:"TopLanes",source:"sounds/Bumper16",volume:.7*e,maxCopies:1}),this.LoadSound({key:"Woosh",source:"sounds/Woosh1",volume:.3*e,maxCopies:1}),this.LoadSound({key:"Metal",source:"sounds/Bumper16",volume:.9*e,maxCopies:1}),this.LoadSound({key:"Siren",source:"sounds/Siren1",volume:.3*e,maxCopies:1}),this.LoadSound({key:"BGMusic",source:"sounds/Underture_Edit_1",volume:.3,maxCopies:1}),this.LoadSound({key:"EndGameMusic",source:"sounds/PinballEdit3",volume:.3,maxCopies:1})},Sounds.StartMusic=function(e){this.sounds.backgroundMusic=new Audio(this.sounds[e].source),Sounds.backgroundVolume=this.sounds[e].volume,this.sounds.backgroundMusic.volume=this.musicMuted?0:Sounds.backgroundVolume,this.sounds.backgroundMusic.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),this.sounds.backgroundMusic.volume=0;try{this.sounds.backgroundMusic.currentTime=0}catch(o){}this.sounds.backgroundMusic.play(),this.musicMuted||this.FadeInMusic(5)},Sounds.FadeOutMusic=function(e,o){function t(){Sounds.fadingTimer+=1;var e=1-Sounds.fadingTimer/Sounds.fadingDuration;Sounds.sounds.backgroundMusic.volume=e*Sounds.volumeAtStartOfFade,Sounds.fadingTimer>=Sounds.fadingDuration?(Sounds.fadingTimeout=null,Sounds.fadingTimer=0,o&&o()):Sounds.fadingTimeout=window.setTimeout(t,100)}return Sounds.fadeOverrideable?(Sounds.fadingTimer=0,Sounds.volumeAtStartOfFade=Sounds.sounds.backgroundMusic.volume,Sounds.fadingDuration=e,Sounds.fadingTimeout&&clearTimeout(Sounds.fadingTimeout),Sounds.fadingTimeout=window.setTimeout(t,100),void 0):!1},Sounds.FadeInMusic=function(e,o){function t(){Sounds.fadingTimer+=1;var e=Sounds.fadingTimer/Sounds.fadingDuration;Sounds.sounds.backgroundMusic.volume=e*(Sounds.backgroundVolume-Sounds.volumeAtStartOfFade)+Sounds.volumeAtStartOfFade,Sounds.fadingTimer>=Sounds.fadingDuration?(Sounds.fadingTimeout=null,Sounds.fadingTimer=0,o&&o()):Sounds.fadingTimeout=window.setTimeout(t,100)}return!Sounds.fadeOverrideable||Sounds.musicMuted?!1:(Sounds.fadingTimer=0,Sounds.volumeAtStartOfFade=Sounds.sounds.backgroundMusic.volume,Sounds.fadingDuration=e,Sounds.fadingTimeout&&clearTimeout(Sounds.fadingTimeout),Sounds.fadingTimeout=window.setTimeout(t,100),void 0)};var audioFeatureChecker=new Audio;Sounds.LoadSound=function(e){if(e.hasOwnProperty("source")&&e.hasOwnProperty("key")){var o="";o=audioFeatureChecker.canPlayType("audio/mpeg;")?e.source+".mp3":e.source+".ogg";var t={source:o,audioObjects:[],volume:1,maxCopies:5};e.hasOwnProperty("volume")&&(t.volume=e.volume),e.hasOwnProperty("maxCopies")&&(t.maxCopies=e.maxCopies),this.sounds[e.key]=t}},Sounds.PlaySound=function(e){if(!this.soundMuted&&this.sounds.hasOwnProperty(e)){for(var o=0,t=0;this.sounds[e].audioObjects.length>t;t++){if(this.sounds[e].audioObjects[t].paused){try{this.sounds[e].audioObjects[t].currentTime=0}catch(a){}this.sounds[e].audioObjects[t].play();break}this.sounds[e].audioObjects[t].currentTime>this.sounds[e].audioObjects[o].currentTime&&(o=t)}if(t==this.sounds[e].audioObjects.length)if(this.sounds[e].maxCopies>t)this.sounds[e].audioObjects.push(new Audio(this.sounds[e].source)),this.sounds[e].audioObjects[t].volume=this.sounds[e].volume,this.sounds[e].audioObjects[t].play();else{try{this.sounds[e].audioObjects[o].currentTime=0}catch(a){}this.sounds[e].audioObjects[o].play()}}},Sounds.StopSound=function(e){if(this.sounds.hasOwnProperty(e))for(var o=0;this.sounds[e].audioObjects.length>o;o++)this.sounds[e].audioObjects[o].paused=!0};var leftFlipperJoint=null,rightFlipperJoint=null,leftFlipperBody=null,rightFlipperBody=null,launcher=null,rampBlocker=null,debugLog="",TOP_LEFT=pixelToB2dCoords(-100,-100),BOTTOM_RIGHT=pixelToB2dCoords(1600,1600),LAUNCHER_SPAWN_POINT=pixelToB2dCoords(TABLE_WIDTH*TABLE_SIZE_SCALE-BALL_RADIUS-5*TABLE_SIZE_SCALE-2*TABLE_SIZE_SCALE,TABLE_HEIGHT*TABLE_SIZE_SCALE-300);App={},App.sensorInfo={},App.sensorsPressed={},App.lastSensorsPressed={},App.lightsToShow=[],App.explosionTimer=-1;var QUALITY_MAX=100,QUALITY_NOSCROLL=75,QUALITY_NOLIGHTS=25;App.qualitySetting=QUALITY_MAX,App.qualityIndex=0,App.qualitySettings=[QUALITY_MAX,QUALITY_NOSCROLL,QUALITY_NOLIGHTS],App.lastObjectHit="",App.objectHit="",App.objectHitTimeout=0;var debugMode=!1,BACKGROUND_URL="img/Tommy_Colour_12b.jpg",pinballCanvas=null,pinballCanvasContext=null,_done=!1,backgroundImages=null,ballImage=null,leftFlipperImage=null,rightFlipperImage=null,currentBackground=0,currentBall=null,launcherTimer=0,launcherForceTimer=0,sensorImage=null,bumperHitImage=null,leftTriangleLightImage=null,rightTriangleLightImage=null,bottomSensorLightImage=null,plateImage=null,arrowImage=null,explosionImage1=null,explosionImage2=null,KEYleftFlipperPressed=!1,KEYrightFlipperPressed=!1,KEYlauncherPressed=!1,gameStarted=!1,EXPLOSION_TIME=79,lL=5,sc=0,cD=!1,highScoreName="",blinkingUnderscoreVisible=!1,blinkNameEntryInterval=null,scoreSubmitted=!1,pointsHit={},lS=0,ALL_TOGGLE_SENSOR_LIST=["BottomSensor1","BottomSensor2","BottomSensor3","BottomSensor4","BottomSensor5","LeftTriangleSensor","RightTriangleSensor"],lightImages=[new Image,new Image,new Image,new Image,new Image,new Image,new Image],LIGHT_COLOUR_BLUE=0,LIGHT_COLOUR_RED=1,LIGHT_COLOUR_GREEN=2,LIGHT_COLOUR_BLUE_ARROW=3,LIGHT_COLOUR_BLUE_OFF=4,LIGHT_COLOUR_RED_OFF=5,LIGHT_COLOUR_GREEN_OFF=6;lightColours=2;var BUMPER_LIGHT_TIME=20,bumperTimers={LeftBumper:0,BottomBumper:0,RightBumper:0},flashTimer=0,flashOnTime=15,SIDE_LIGHT_LOOP_TIME=50,sideLightTimer=SIDE_LIGHT_LOOP_TIME,LANE_LIGHT_LOOP_TIME=60,lineLightTimer=LANE_LIGHT_LOOP_TIME,CENTER_LIGHT_LOOP_TIME=68,centerLightTimer=100,scrollingKeys=[37,38,39,40];$(document).ready(function(){Initialize(),setupWorld(),setupBoard(),$("html").addClass("intro"),$(".pinballoozaHolder").css("display","none"),$(".soundToggle").click(function(){Sounds.soundMuted?$(this).removeClass("off").addClass("on"):$(this).removeClass("on").addClass("off"),Sounds.soundMuted=!Sounds.soundMuted}),$(".musicToggle").click(function(){Sounds.musicMuted=!Sounds.musicMuted,Sounds.musicMuted?($(this).removeClass("on").addClass("off"),Sounds.FadeOutMusic(6)):($(this).removeClass("off").addClass("on"),Sounds.FadeInMusic(6))}),$(".quality").click(function(){0==App.qualityIndex?(App.qualityIndex=1,$(".quality").removeClass("high").addClass("medium").removeClass("low")):1==App.qualityIndex?(App.qualityIndex=2,$(".quality").removeClass("high").removeClass("medium").addClass("low")):2==App.qualityIndex&&(App.qualityIndex=0,$(".quality").addClass("high").removeClass("medium").removeClass("low")),App.qualitySetting=App.qualitySettings[App.qualityIndex]}),$(window).width()>768&&($("html").removeClass("touch"),$(window).resize(function(){$(".page-container").css("height",$(window).height()-1+"px").css("overflow","hidden");var e=411,o=$(".footer-container").height(),t=$(window).height(),a=t-e-o;$("#tableWrapper").css("height",a),$("header").css("height",e+"px");var n=$("#pinballCanvas").offset().left;$(".header-container").css("background-position",n-378+"px 2px"),$(".footer-container").css("background-position",n-378+"px -846px")}),$(window).resize(),$(".page-container").css("height",$(window).height()-1+"px").css("overflow","hidden")),$(".playButton").click(ShowInstructions),$(".startButtonContainer").click(StartGame),$(function(){$("a[href*='http']").each(function(){$(this).click(function(e){var o="/outgoing/"+$(this).attr("href");_gaq.push(["Outbound Links",o]);var t=$(this).attr("href");return setTimeout(function(){location.href=t},100),e.preventDefault(),!1})}),$("a[href*='mailto']").each(function(){$(this).click(function(){var e="/mailto/"+$(this).attr("href").substring(7);_gaq.push(["Mailto",e])})}),$("a[href*='#']").each(function(){$(this).click(function(){var e="/anchor/"+$(this).attr("href").substring(1);_gaq.push(["Anchors",e])})})})});